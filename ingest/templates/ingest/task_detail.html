{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="taskProgress({{ task.id }}, '{{ task.status }}', '{{ task.step }}')">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold mb-2">Ingestion Task</h1>
            <p class="text-gray-500">Task ID: {{ task.id }}</p>
        </div>
        <div>
            <a href="{% url 'task_list' %}" class="btn btn-outline">Back to List</a>
        </div>
    </div>

    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">{{ task.file_name }}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <h3 class="font-bold text-gray-500 uppercase text-sm mb-1">Status</h3>
                    <div class="badge badge-lg" 
                          :class="'badge-' + (statusColors[status] || 'ghost')"
                          x-text="status.charAt(0).toUpperCase() + status.slice(1)">
                        {{ task.get_status_display }}
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-500 uppercase text-sm mb-1">Created At</h3>
                    <p>{{ task.created_at|date:"F j, Y, g:i a" }}</p>
                </div>
            </div>

            <div class="divider">Progress</div>

            <div class="w-full py-4">
                <ul class="steps steps-horizontal w-full">
                    {% for step_item in steps %}
                    <li class="steps-item step" 
                        :class="stepIndex >= {{ forloop.counter0 }} ? 'step-primary' : ''">
                        {{ step_item.label }}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card-actions justify-end mt-6">
                <template x-if="activeStatuses.includes(status)">
                    <form action="{% url 'cancel_task' task.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-error">Cancel Task</button>
                    </form>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        // Pass the steps configuration from Django to JS
        const stepsConfig = [
            {% for step_item in steps %}
            {
                value: "{{ step_item.value }}", 
                index: {{ forloop.counter0 }}
            },
            {% endfor %}
        ];

        // Pass status configuration
        const statusColors = {{ status_colors|safe }};
        const activeStatuses = {{ active_statuses|safe }};

        Alpine.data('taskProgress', (taskId, initialStatus, initialStep) => ({
            status: initialStatus.toLowerCase(),
            step: initialStep.toLowerCase(),
            statusColors: statusColors,
            activeStatuses: activeStatuses,
            eventSource: null,

            init() {
                if (this.activeStatuses.includes(this.status)) {
                    this.connect();
                }
            },

            connect() {
                if (this.eventSource) return;
                console.log(`Connecting SSE for task ${taskId}`);
                this.eventSource = new EventSource(`/ingest/tasks/${taskId}/progress/`);
                
                this.eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.error) {
                         this.disconnect();
                         return;
                    }

                    this.status = data.status.toLowerCase();
                    this.step = data.step.toLowerCase();
                    
                    if (!this.activeStatuses.includes(this.status)) {
                        this.disconnect();
                    }
                };

                this.eventSource.onerror = (err) => {
                    console.error('SSE Error:', err);
                    this.disconnect();
                };
            },

            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
            },

            get stepIndex() {
                const currentStep = stepsConfig.find(s => s.value === this.step);
                return currentStep ? currentStep.index : -1;
            }
        }))
    })
</script>
{% endblock %}
